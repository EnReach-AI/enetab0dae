# Flutter FFI 集成指南

## 概述

本指南介绍如何在 Flutter 应用中集成 Go 编写的 study 库，通过 FFI（Foreign Function Interface）调用底层密钥管理和 API 交互功能。

## 环境设置

### Android 配置

#### 1. build.gradle (app level)

```gradle
android {
    compileSdkVersion 34
    
    defaultConfig {
        minSdkVersion 21
        targetSdkVersion 34
        
        // 指定支持的 CPU 架构
        ndk {
            abiFilters 'arm64-v8a', 'armeabi-v7a'
        }
    }
    
    // 编译选项
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_1_8
        targetCompatibility JavaVersion.VERSION_1_8
    }
}
```

#### 2. CMakeLists.txt (native 配置)

```cmake
cmake_minimum_required(VERSION 3.10)

project(aro_study)

# 添加预构建的 so 库
add_library(study SHARED IMPORTED)
set_target_properties(study PROPERTIES
    IMPORTED_LOCATION ${CMAKE_CURRENT_SOURCE_DIR}/libs/${ANDROID_ABI}/libstudy.so
)

# 创建包装库
add_library(native_lib SHARED src/main/cpp/native-lib.cpp)

target_link_libraries(native_lib study)
```

#### 3. 放置 .so 文件

```
app/src/main/jniLibs/
├── arm64-v8a/
│   └── libstudy.so
└── armeabi-v7a/
    └── libstudy.so
```

### iOS 配置

#### 1. ios/Podfile

```ruby
post_install do |installer|
  installer.pods_project.targets.each do |target|
    flutter_additional_ios_build_settings(target)
    target.build_configurations.each do |config|
      config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'] ||= [
        '$(inherited)',
        'FLUTTER_ROOT=\$(FLUTTER_ROOT)',
      ]
    end
  end
end
```

#### 2. 放置 libstudy.a 文件

```
ios/Runner.xcodeproj/
└── libstudy.a (拖入 Xcode 项目)
```

## Dart FFI 绑定

### 1. pubspec.yaml 配置

```yaml
dependencies:
  ffi: ^2.0.0
  path_provider: ^2.0.0
  uuid: ^4.0.0
  
dev_dependencies:
  ffigen: ^10.0.0
```

### 2. ffigen 配置 (ffigen.yaml)

```yaml
output: 'lib/generated/study_bindings.dart'
headers:
  entry-points:
    - 'core/pkg/libstudy/study.h'

library-template: |
  // Generated by ffigen
  import 'dart:ffi' as ffi;
  
  class StudyLib {
    late final ffi.DynamicLibrary _dylib;
    
    StudyLib(ffi.DynamicLibrary dylib) : _dylib = dylib;
    
    StudyLib.process() : _dylib = ffi.DynamicLibrary.process();
  }
```

### 3. study.h (C 头文件)

创建 `core/pkg/libstudy/study.h`:

```c
#ifndef MINING_H
#define MINING_H

#include <stdint.h>

// 初始化密钥对，返回 0 表示成功
int InitKeyPair(const char* baseDir);

// 获取公钥 (PEM 格式)
const char* GetPublicKey();

// 注册节点
const char* RegisterNode(const char* clientId);

// 通用 API 调用
const char* CallAPI(const char* method, const char* path, const char* bodyJSON);

// 设置 API URL
int SetAPIURL(const char* url);

// 设置 WebSocket URL
int SetWSURL(const char* url);

// 获取矿机统计信息
const char* GetMiningStats();

// 启动挖矿
int StartMining();

// 停止挖矿
int StopMining();

// 释放内存 (C 字符串)
void FreeMemory(void* ptr);

#endif // MINING_H
```

### 4. Dart FFI 绑定类

创建 `lib/bindings/study_lib.dart`:

```dart
import 'dart:ffi' as ffi;
import 'dart:io';
import 'package:ffi/ffi.dart';

// FFI 函数签名定义
typedef InitKeyPairC = ffi.Int Function(ffi.Pointer<ffi.Char>);
typedef InitKeyPairDart = int Function(ffi.Pointer<ffi.Char>);

typedef GetPublicKeyC = ffi.Pointer<ffi.Char> Function();
typedef GetPublicKeyDart = ffi.Pointer<ffi.Char> Function();

typedef RegisterNodeC = ffi.Pointer<ffi.Char> Function(
    ffi.Pointer<ffi.Char>);
typedef RegisterNodeDart = ffi.Pointer<ffi.Char> Function(
    ffi.Pointer<ffi.Char>);

typedef CallAPIC = ffi.Pointer<ffi.Char> Function(
    ffi.Pointer<ffi.Char>,
    ffi.Pointer<ffi.Char>,
    ffi.Pointer<ffi.Char>);
typedef CallAPIDart = ffi.Pointer<ffi.Char> Function(
    ffi.Pointer<ffi.Char>,
    ffi.Pointer<ffi.Char>,
    ffi.Pointer<ffi.Char>);

typedef SetAPIUrlC = ffi.Int Function(ffi.Pointer<ffi.Char>);
typedef SetAPIUrlDart = int Function(ffi.Pointer<ffi.Char>);

typedef SetWSUrlC = ffi.Int Function(ffi.Pointer<ffi.Char>);
typedef SetWSUrlDart = int Function(ffi.Pointer<ffi.Char>);

typedef GetMiningStatsC = ffi.Pointer<ffi.Char> Function();
typedef GetMiningStatsDart = ffi.Pointer<ffi.Char> Function();

typedef StartMiningC = ffi.Int Function();
typedef StartMiningDart = int Function();

typedef StopMiningC = ffi.Int Function();
typedef StopMiningDart = int Function();

typedef FreeMemoryC = ffi.Void Function(ffi.Pointer<ffi.Void>);
typedef FreeMemoryDart = void Function(ffi.Pointer<ffi.Void>);

/// FFI 库包装类
class StudyLib {
  final ffi.DynamicLibrary _dylib;
  
  late final InitKeyPairDart _initKeyPair;
  late final GetPublicKeyDart _getPublicKey;
  late final RegisterNodeDart _registerNode;
  late final CallAPIDart _callAPI;
  late final SetAPIUrlDart _setAPIUrl;
  late final SetWSUrlDart _setWSUrl;
  late final GetMiningStatsDart _getMiningStats;
  late final StartMiningDart _startMining;
  late final StopMiningDart _stopMining;
  late final FreeMemoryDart _freeMemory;
  
  StudyLib(this._dylib) {
    _initKeyPair = _dylib
        .lookup<ffi.NativeFunction<InitKeyPairC>>('InitKeyPair')
        .asFunction();
    _getPublicKey = _dylib
        .lookup<ffi.NativeFunction<GetPublicKeyC>>('GetPublicKey')
        .asFunction();
    _registerNode = _dylib
        .lookup<ffi.NativeFunction<RegisterNodeC>>('RegisterNode')
        .asFunction();
    _callAPI = _dylib
        .lookup<ffi.NativeFunction<CallAPIC>>('CallAPI')
        .asFunction();
    _setAPIUrl = _dylib
        .lookup<ffi.NativeFunction<SetAPIUrlC>>('SetAPIURL')
        .asFunction();
    _setWSUrl = _dylib
        .lookup<ffi.NativeFunction<SetWSUrlC>>('SetWSURL')
        .asFunction();
    _getMiningStats = _dylib
        .lookup<ffi.NativeFunction<GetMiningStatsC>>('GetMiningStats')
        .asFunction();
    _startMining = _dylib
        .lookup<ffi.NativeFunction<StartMiningC>>('StartMining')
        .asFunction();
    _stopMining = _dylib
        .lookup<ffi.NativeFunction<StopMiningC>>('StopMining')
        .asFunction();
    _freeMemory = _dylib
        .lookup<ffi.NativeFunction<FreeMemoryC>>('FreeMemory')
        .asFunction();
  }
  
  /// 从 app 路径加载库
  factory StudyLib.open(String path) {
    final dylib = ffi.DynamicLibrary.open(path);
    return StudyLib(dylib);
  }
  
  /// 初始化密钥对
  /// 返回 0 表示成功，-1 表示失败
  int initKeyPair(String baseDir) {
    final baseDirPtr = baseDir.toNativeUtf8();
    try {
      return _initKeyPair(baseDirPtr.cast());
    } finally {
      malloc.free(baseDirPtr);
    }
  }
  
  /// 获取公钥 (PEM 格式)
  String getPublicKey() {
    final ptr = _getPublicKey();
    final result = ptr.cast<Utf8>().toDartString();
    _freeMemory(ptr.cast());
    return result;
  }
  
  /// 注册节点，返回 JSON 字符串
  String registerNode(String clientId) {
    final clientIdPtr = clientId.toNativeUtf8();
    try {
      final resultPtr = _registerNode(clientIdPtr.cast());
      final result = resultPtr.cast<Utf8>().toDartString();
      _freeMemory(resultPtr.cast());
      return result;
    } finally {
      malloc.free(clientIdPtr);
    }
  }
  
  /// 通用 API 调用
  String callAPI(String method, String path, String bodyJSON) {
    final methodPtr = method.toNativeUtf8();
    final pathPtr = path.toNativeUtf8();
    final bodyPtr = bodyJSON.toNativeUtf8();
    try {
      final resultPtr = _callAPI(
        methodPtr.cast(),
        pathPtr.cast(),
        bodyPtr.cast(),
      );
      final result = resultPtr.cast<Utf8>().toDartString();
      _freeMemory(resultPtr.cast());
      return result;
    } finally {
      malloc.free(methodPtr);
      malloc.free(pathPtr);
      malloc.free(bodyPtr);
    }
  }
  
  /// 设置 API URL
  int setAPIUrl(String url) {
    final urlPtr = url.toNativeUtf8();
    try {
      return _setAPIUrl(urlPtr.cast());
    } finally {
      malloc.free(urlPtr);
    }
  }
  
  /// 设置 WebSocket URL
  int setWSUrl(String url) {
    final urlPtr = url.toNativeUtf8();
    try {
      return _setWSUrl(urlPtr.cast());
    } finally {
      malloc.free(urlPtr);
    }
  }
  
  /// 获取矿机统计信息
  String getMiningStats() {
    final ptr = _getMiningStats();
    final result = ptr.cast<Utf8>().toDartString();
    _freeMemory(ptr.cast());
    return result;
  }
  
  /// 启动挖矿
  int startMining() {
    return _startMining();
  }
  
  /// 停止挖矿
  int stopMining() {
    return _stopMining();
  }
}
```

## Flutter 服务层实现

创建 `lib/services/study_service.dart`:

```dart
import 'dart:async';
import 'dart:convert';
import 'package:path_provider/path_provider.dart';
import '../bindings/study_lib.dart';

class MiningService {
  late StudyLib _studyLib;
  String? _clientId;
  bool _isInitialized = false;
  
  final StreamController<MiningStatsEvent> _statsController = 
      StreamController<MiningStatsEvent>.broadcast();
  
  Stream<MiningStatsEvent> get statsStream => _statsController.stream;
  
  bool get isInitialized => _isInitialized;
  String? get clientId => _clientId;
  
  /// 初始化服务
  Future<bool> initialize({
    required String libPath,
    String? apiUrl,
    String? wsUrl,
  }) async {
    try {
      // 加载库
      _studyLib = StudyLib.open(libPath);
      
      // 获取应用文件目录
      final appDir = await getApplicationDocumentsDirectory();
      final keyDir = appDir.path;
      
      // 初始化密钥对
      final result = _studyLib.initKeyPair(keyDir);
      if (result != 0) {
        print('❌ 密钥对初始化失败');
        return false;
      }
      
      // 配置 API URL
      if (apiUrl != null) {
        _studyLib.setAPIUrl(apiUrl);
      } else {
        _studyLib.setAPIUrl('https://testnet-api.aro.network');
      }
      
      // 配置 WebSocket URL
      if (wsUrl != null) {
        _studyLib.setWSUrl(wsUrl);
      } else {
        _studyLib.setWSUrl('https://testnet-ws.aro.network');
      }
      
      _isInitialized = true;
      print('✅ MiningService 初始化成功');
      return true;
    } catch (e) {
      print('❌ 初始化错误: $e');
      return false;
    }
  }
  
  /// 注册节点
  Future<NodeRegistrationResponse?> registerNode(String nodeId) async {
    if (!_isInitialized) {
      throw Exception('MiningService 未初始化');
    }
    
    try {
      _clientId = nodeId;
      
      final response = _studyLib.registerNode(nodeId);
      final data = jsonDecode(response);
      
      if (data['code'] == 200) {
        return NodeRegistrationResponse.fromJson(data['data']);
      } else {
        print('❌ 注册失败: ${data['message']}');
        return null;
      }
    } catch (e) {
      print('❌ 注册错误: $e');
      return null;
    }
  }
  
  /// 获取节点信息
  Future<Map<String, dynamic>?> getNodeInfo(String nodeId) async {
    try {
      final response = _studyLib.callAPI('GET', '/api/node/$nodeId', '{}');
      final data = jsonDecode(response);
      
      if (data['code'] == 200) {
        return data['data'];
      }
      return null;
    } catch (e) {
      print('❌ 获取节点信息失败: $e');
      return null;
    }
  }
  
  /// 启动挖矿
  Future<bool> startMining() async {
    if (!_isInitialized) {
      throw Exception('MiningService 未初始化');
    }
    
    try {
      final result = _studyLib.startMining();
      if (result == 0) {
        print('✅ 挖矿已启动');
        _startStatsPolling();
        return true;
      } else {
        print('❌ 启动挖矿失败');
        return false;
      }
    } catch (e) {
      print('❌ 启动错误: $e');
      return false;
    }
  }
  
  /// 停止挖矿
  Future<bool> stopMining() async {
    try {
      final result = _studyLib.stopMining();
      if (result == 0) {
        print('✅ 挖矿已停止');
        return true;
      }
      return false;
    } catch (e) {
      print('❌ 停止错误: $e');
      return false;
    }
  }
  
  /// 获取矿机统计信息
  Future<MiningStats?> getMiningStats() async {
    try {
      final response = _studyLib.getMiningStats();
      final data = jsonDecode(response);
      
      return MiningStats.fromJson(data);
    } catch (e) {
      print('❌ 获取统计信息失败: $e');
      return null;
    }
  }
  
  /// 获取公钥
  String getPublicKey() {
    return _studyLib.getPublicKey();
  }
  
  /// 通用 API 调用
  Future<Map<String, dynamic>> callAPI(
    String method,
    String path,
    Map<String, dynamic> body,
  ) async {
    try {
      final response = _studyLib.callAPI(
        method,
        path,
        jsonEncode(body),
      );
      return jsonDecode(response);
    } catch (e) {
      print('❌ API 调用失败: $e');
      return {'code': 500, 'message': e.toString()};
    }
  }
  
  /// 定期更新统计信息
  void _startStatsPolling() {
    Timer.periodic(Duration(seconds: 5), (timer) async {
      try {
        final stats = await getMiningStats();
        if (stats != null) {
          _statsController.add(MiningStatsEvent(stats));
        }
      } catch (e) {
        print('⚠️ 统计信息更新失败: $e');
      }
    });
  }
  
  void dispose() {
    _statsController.close();
  }
}

/// 节点注册响应
class NodeRegistrationResponse {
  final String serialNumber;
  
  NodeRegistrationResponse({required this.serialNumber});
  
  factory NodeRegistrationResponse.fromJson(Map<String, dynamic> json) {
    return NodeRegistrationResponse(
      serialNumber: json['serialNumber'] ?? '',
    );
  }
}

/// 矿机统计信息
class MiningStats {
  final bool running;
  final int hashrate;
  final int totalShares;
  final int validShares;
  final double efficiency;
  final int uptime;
  
  MiningStats({
    required this.running,
    required this.hashrate,
    required this.totalShares,
    required this.validShares,
    required this.efficiency,
    required this.uptime,
  });
  
  factory MiningStats.fromJson(Map<String, dynamic> json) {
    return MiningStats(
      running: json['running'] ?? false,
      hashrate: json['hashrate'] ?? 0,
      totalShares: json['totalShares'] ?? 0,
      validShares: json['validShares'] ?? 0,
      efficiency: (json['efficiency'] ?? 0.0).toDouble(),
      uptime: json['uptime'] ?? 0,
    );
  }
}

/// 矿机统计事件
class MiningStatsEvent {
  final MiningStats stats;
  final DateTime timestamp;
  
  MiningStatsEvent(this.stats) : timestamp = DateTime.now();
}
```

## 使用示例

### 初始化和注册

```dart
import 'package:path_provider/path_provider.dart';
import 'services/study_service.dart';

void main() {
  runApp(MyApp());
}

class MiningApp extends StatefulWidget {
  @override
  State<MiningApp> createState() => _MiningAppState();
}

class _MiningAppState extends State<MiningApp> {
  final MiningService _studyService = MiningService();
  String? _serialNumber;
  bool _isInitialized = false;
  
  @override
  void initState() {
    super.initState();
    _initializeMining();
  }
  
  Future<void> _initializeMining() async {
    // 获取库的路径
    final libPath = await _getLibraryPath();
    
    // 初始化服务
    final success = await _studyService.initialize(
      libPath: libPath,
      apiUrl: 'https://testnet-api.aro.network',
      wsUrl: 'https://testnet-ws.aro.network',
    );
    
    if (!success) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('❌ 初始化失败')),
      );
      return;
    }
    
    // 注册节点
    const nodeId = 'my-node-001';
    final response = await _studyService.registerNode(nodeId);
    
    if (response != null) {
      setState(() {
        _serialNumber = response.serialNumber;
        _isInitialized = true;
      });
      
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('✅ 注册成功：${response.serialNumber}')),
      );
    }
  }
  
  Future<String> _getLibraryPath() async {
    if (Platform.isAndroid) {
      return 'libstudy.so';
    } else if (Platform.isIOS) {
      return 'libstudy.a';
    }
    throw UnsupportedError('不支持的平台');
  }
  
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('ARO Mining')),
      body: Column(
        children: [
          if (_isInitialized) ...[
            Text('节点序列号: $_serialNumber'),
            ElevatedButton(
              onPressed: () => _studyService.startMining(),
              child: Text('启动挖矿'),
            ),
            ElevatedButton(
              onPressed: () => _studyService.stopMining(),
              child: Text('停止挖矿'),
            ),
            StreamBuilder<MiningStatsEvent>(
              stream: _studyService.statsStream,
              builder: (context, snapshot) {
                if (snapshot.hasData) {
                  final stats = snapshot.data!.stats;
                  return MiningStatsWidget(stats: stats);
                }
                return Text('加载统计信息...');
              },
            ),
          ] else ...[
            CircularProgressIndicator(),
            Text('初始化中...'),
          ]
        ],
      ),
    );
  }
  
  @override
  void dispose() {
    _studyService.dispose();
    super.dispose();
  }
}

class MiningStatsWidget extends StatelessWidget {
  final MiningStats stats;
  
  const MiningStatsWidget({required this.stats});
  
  @override
  Widget build(BuildContext context) {
    return Card(
      child: Padding(
        padding: EdgeInsets.all(16),
        child: Column(
          children: [
            Text('Hashrate: ${stats.hashrate} H/s'),
            Text('Valid Shares: ${stats.validShares}/${stats.totalShares}'),
            Text('Efficiency: ${stats.efficiency.toStringAsFixed(2)}%'),
            Text('Uptime: ${_formatDuration(stats.uptime)}'),
          ],
        ),
      ),
    );
  }
  
  String _formatDuration(int seconds) {
    final duration = Duration(seconds: seconds);
    return '${duration.inHours}h ${duration.inMinutes % 60}m ${duration.inSeconds % 60}s';
  }
}
```

## 编译 Go 库

### Android

```bash
cd core

# 为 arm64-v8a 编译
GOOS=android GOARCH=arm64 go build \
    -buildmode=c-shared \
    -o ../plugins/android/arm64-v8a/libstudy.so \
    ./pkg/libstudy

# 为 armeabi-v7a 编译
GOOS=android GOARCH=arm CC=arm-linux-androideabi-gcc \
    go build \
    -buildmode=c-shared \
    -o ../plugins/android/armeabi-v7a/libstudy.so \
    ./pkg/libstudy
```

### iOS

```bash
cd core

# 为 iOS 编译（arm64）
GOOS=ios GOARCH=arm64 go build \
    -buildmode=c-archive \
    -o ../plugins/ios/libstudy_arm64.a \
    ./pkg/libstudy

# 为 iOS 模拟器编译（amd64）
GOOS=ios GOARCH=amd64 go build \
    -buildmode=c-archive \
    -o ../plugins/ios/libstudy_amd64.a \
    ./pkg/libstudy

# 合并成通用库
lipo -create \
    ../plugins/ios/libstudy_arm64.a \
    ../plugins/ios/libstudy_amd64.a \
    -output ../plugins/ios/libstudy.a
```

## 故障排查

### "library not found" 错误

检查项：
- [ ] 库文件是否存在
- [ ] 库路径是否正确
- [ ] Android: 库文件是否在 `jniLibs/{architecture}` 目录
- [ ] iOS: 库文件是否链接到 target

### FFI 函数调用失败

检查项：
- [ ] 函数名是否正确（区分大小写）
- [ ] 参数类型是否匹配
- [ ] 内存释放是否正确（调用 FreeMemory）

### 密钥文件找不到

检查项：
- [ ] `initKeyPair` 是否已调用
- [ ] 路径是否有正确权限
- [ ] 文件是否存在：`aro_rsa` 和 `aro_rsa.pub`

### API 调用返回 401

检查项：
- [ ] 密钥对是否正确初始化
- [ ] API URL 是否正确
- [ ] 网络连接是否正常
- [ ] 系统时间是否准确
