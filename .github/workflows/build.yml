name: Build All

on:
  push:
    branches: ["main"]
    paths:
      - "core/**"
      - "apps/aro_client/**"
      - "Dockerfile.*"
      - ".github/workflows/build.yml"
  pull_request:
    paths:
      - "core/**"
      - "apps/aro_client/**"
  workflow_dispatch:

env:
  FLUTTER_DIR: apps/aro_client

jobs:
  prepare:
    name: Parse commit tags
    runs-on: ubuntu-latest
    outputs:
      build_core: ${{ steps.flags.outputs.build_core }}
      win: ${{ steps.flags.outputs.win }}
      mac: ${{ steps.flags.outputs.mac }}
      linux: ${{ steps.flags.outputs.linux }}
      android: ${{ steps.flags.outputs.android }}
      ios: ${{ steps.flags.outputs.ios }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - id: flags
        env:
          EVENT_NAME: ${{ github.event_name }}
          PUSH_BEFORE: ${{ github.event.before }}
          PR_BASE_SHA: ${{ github.event.pull_request.base.sha }}
          PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          CURRENT_SHA: ${{ github.sha }}
        run: |
          MSG="$(git log -1 --pretty=%B)"
          echo "Commit message: $MSG"

          if [[ "$MSG" == *"[all]"* ]]; then
            echo "build_core=true" >> $GITHUB_OUTPUT
            echo "linux=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 检查 core 目录是否有变化，决定是否构建核心库
          # 说明:GitHub Actions 默认是浅克隆，直接使用 HEAD~1 可能不存在。
          CHANGED_FILES=""
          if [[ "${EVENT_NAME}" == "pull_request" && -n "${PR_BASE_SHA}" && -n "${PR_HEAD_SHA}" ]]; then
            git fetch --no-tags --prune --depth=1 origin "${PR_BASE_SHA}" "${PR_HEAD_SHA}" || true
            CHANGED_FILES="$(git diff --name-only "${PR_BASE_SHA}" "${PR_HEAD_SHA}" || true)"
          elif [[ "${EVENT_NAME}" == "push" && -n "${PUSH_BEFORE}" ]]; then
            # 第一次 push 或强推时 before 可能是全 0
            if [[ "${PUSH_BEFORE}" != "0000000000000000000000000000000000000000" ]]; then
              git fetch --no-tags --prune --depth=1 origin "${PUSH_BEFORE}" "${CURRENT_SHA}" || true
              CHANGED_FILES="$(git diff --name-only "${PUSH_BEFORE}" "${CURRENT_SHA}" || true)"
            else
              CHANGED_FILES="$(git show --name-only --pretty='' "${CURRENT_SHA}" || true)"
            fi
          else
            # workflow_dispatch 等场景：退化为当前提交的变更
            CHANGED_FILES="$(git show --name-only --pretty='' "${CURRENT_SHA}" || true)"
          fi

          if printf '%s\n' "${CHANGED_FILES}" | grep -q '^core/'; then
            echo "build_core=true" >> $GITHUB_OUTPUT
          fi

          # 如果 Flutter 客户端有变更，默认只构建 Linux 客户端（暂时关闭 Win/mac/iOS/Android）
          if printf '%s\n' "${CHANGED_FILES}" | grep -q '^apps/aro_client/'; then
            echo "linux=true" >> $GITHUB_OUTPUT
          fi

          # 标签仍保留解析，但对应平台构建目前被禁用
          [[ "$MSG" == *"[win]"* ]] && echo "win=true" >> $GITHUB_OUTPUT
          [[ "$MSG" == *"[mac]"* ]] && echo "mac=true" >> $GITHUB_OUTPUT
          [[ "$MSG" == *"[linux]"* ]] && echo "linux=true" >> $GITHUB_OUTPUT
          [[ "$MSG" == *"[android]"* ]] && echo "android=true" >> $GITHUB_OUTPUT
          [[ "$MSG" == *"[ios]"* ]] && echo "ios=true" >> $GITHUB_OUTPUT

          exit 0

  # ============================================================
  # Core Library Build Jobs
  # ============================================================

  build-core-linux:
    needs: prepare
    if: needs.prepare.outputs.build_core == 'true'
    # if: false
    name: Build Core Linux x64
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.25"

      - name: Build Linux x64
        run: |
          cd core
          CGO_ENABLED=1 GOOS=linux GOARCH=amd64 go build \
            -buildmode=c-shared -trimpath -ldflags="-s -w -buildid=" \
            -o ../plugins/linux/libstudy.so ./pkg/libstudy
          ls -lh ../plugins/linux/libstudy.so

      - name: Copy library to Flutter FFI directory
        run: |
          mkdir -p apps/aro_client/lib/ffi/linux
          cp plugins/linux/libstudy.so apps/aro_client/lib/ffi/linux/
          ls -lh apps/aro_client/lib/ffi/linux/libstudy.so

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: libstudy-linux
          path: plugins/linux/

  build-core-linux-arm64:
    needs: prepare
    if: true
    name: Build Core Linux ARM64
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.25"

      - name: Install ARM64 cross-compiler
        run: sudo apt-get update && sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Build Linux ARM64
        run: |
          cd core
          CC=aarch64-linux-gnu-gcc CGO_ENABLED=1 GOOS=linux GOARCH=arm64 go build \
            -buildmode=c-shared -trimpath -ldflags="-s -w -buildid=" \
            -o ../plugins/linux-arm64/libstudy.so ./pkg/libstudy
          ls -lh ../plugins/linux-arm64/libstudy.so

      - name: Copy library to Flutter FFI directory
        run: |
          mkdir -p apps/aro_client/lib/ffi/linux-arm64
          cp plugins/linux-arm64/libstudy.so apps/aro_client/lib/ffi/linux-arm64/
          ls -lh apps/aro_client/lib/ffi/linux-arm64/libstudy.so

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: libstudy-linux-arm64
          path: plugins/linux-arm64/

  build-core-windows:
    needs: prepare
    if: needs.prepare.outputs.build_core == 'true'
    name: Build Core Windows x64
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.25"

      - name: Install MinGW
        run: sudo apt-get update && sudo apt-get install -y mingw-w64

      - name: Build Windows x64
        run: |
          cd core
          CC=x86_64-w64-mingw32-gcc CGO_ENABLED=1 GOOS=windows GOARCH=amd64 go build \
            -buildmode=c-shared -trimpath -ldflags="-s -w -buildid=" \
            -o ../plugins/windows/libstudy.dll ./pkg/libstudy
          ls -lh ../plugins/windows/libstudy.dll

      - name: Copy library to Flutter FFI directory
        run: |
          mkdir -p apps/aro_client/lib/ffi/windows
          cp plugins/windows/libstudy.dll apps/aro_client/lib/ffi/windows/
          ls -lh apps/aro_client/lib/ffi/windows/libstudy.dll

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: libstudy-windows
          path: plugins/windows/

  build-core-macos:
    needs: prepare
    if: false # temporarily disabled
    name: Build Core macOS
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.25"

      - name: Build macOS ARM64
        run: |
          cd core
          CGO_ENABLED=1 GOOS=darwin GOARCH=arm64 go build \
            -buildmode=c-shared -trimpath -ldflags="-s -w -buildid=" \
            -o ../plugins/macos/libstudy.dylib ./pkg/libstudy
          ls -lh ../plugins/macos/libstudy.dylib

      - name: Copy library to Flutter FFI directory
        run: |
          mkdir -p apps/aro_client/lib/ffi/macos
          cp plugins/macos/libstudy.dylib apps/aro_client/lib/ffi/macos/
          ls -lh apps/aro_client/lib/ffi/macos/libstudy.dylib

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: libstudy-macos
          path: plugins/macos/

  build-core-android:
    needs: prepare
    if: false # temporarily disabled
    name: Build Core Android ARM64
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.25"

      - name: Set up Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25c

      - name: Build Android ARM64
        run: |
          cd core
          CC="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang" \
          CGO_ENABLED=1 GOOS=android GOARCH=arm64 go build \
            -buildmode=c-shared -trimpath -ldflags="-s -w -buildid=" \
            -o ../plugins/android/libstudy.so ./pkg/libstudy
          ls -lh ../plugins/android/libstudy.so

      - name: Copy library to Flutter FFI directory
        run: |
          mkdir -p apps/aro_client/lib/ffi/android
          cp plugins/android/libstudy.so apps/aro_client/lib/ffi/android/
          ls -lh apps/aro_client/lib/ffi/android/libstudy.so

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: libstudy-android
          path: plugins/android/

  build-core-ios:
    needs: prepare
    if: false # temporarily disabled
    name: Build Core iOS
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.25"

      - name: Build iOS ARM64
        run: |
          cd core
          CGO_ENABLED=1 GOOS=ios GOARCH=arm64 \
          CGO_CFLAGS="-fembed-bitcode" \
          CGO_LDFLAGS="-fembed-bitcode" \
          SDK=iphoneos go build -buildmode=c-archive \
            -trimpath -ldflags="-s -w -buildid=" \
            -o ../plugins/ios/libstudy.a ./pkg/libstudy
          ls -lh ../plugins/ios/libstudy.a

      - name: Copy library to Flutter FFI directory
        run: |
          mkdir -p apps/aro_client/lib/ffi/ios
          cp plugins/ios/libstudy.a apps/aro_client/lib/ffi/ios/
          ls -lh apps/aro_client/lib/ffi/ios/libstudy.a

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: libstudy-ios
          path: plugins/ios/

  # ============================================================
  # Client App Build Jobs
  # ============================================================
  build-linux:
    needs: [build-core-linux, build-core-linux-arm64]
    name: Build Flutter Linux Packages
    strategy:
      matrix:
        distro: ["ubuntu:22.04", "debian:11", "centos:8"]
    runs-on: ubuntu-latest
    container:
      image: ${{ matrix.distro }}

    env:
      FLUTTER_DIR: apps/aro_client
      FLUTTER_VERSION: 3.38.5

    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          if [ -f /etc/debian_version ]; then
            apt-get update
            DEBIAN_FRONTEND=noninteractive apt-get install -y git curl jq clang cmake ninja-build \
              pkg-config libgtk-3-dev ruby ruby-dev build-essential unzip
            if ! DEBIAN_FRONTEND=noninteractive apt-get install -y libwebkit2gtk-4.1-dev; then
              DEBIAN_FRONTEND=noninteractive apt-get install -y libwebkit2gtk-4.0-dev
            fi
            gem install --no-document fpm

          elif [ -f /etc/centos-release ]; then
            dnf install -y epel-release
            sed -i 's|mirrorlist=|#mirrorlist=|g' /etc/yum.repos.d/CentOS-*
            sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-*
            dnf makecache
            dnf install -y git curl jq gtk3-devel webkit2gtk3-devel ruby ruby-devel rubygems unzip cmake clang
            dnf groupinstall -y "Development Tools"
            gem install --no-document fpm

            # install ninja binary
            if ! command -v ninja &> /dev/null; then
              curl -L https://github.com/ninja-build/ninja/releases/download/v1.11.1/ninja-linux.zip -o /tmp/ninja.zip
              unzip /tmp/ninja.zip -d /usr/local/bin
              chmod +x /usr/local/bin/ninja
            fi
          fi

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      # Flutter build
      - name: Build Flutter Linux App
        working-directory: ${{ env.FLUTTER_DIR }}
        run: |
          export PATH="/usr/local/bin:$PATH"
          flutter config --enable-linux-desktop
          flutter precache --linux
          flutter pub get
          flutter build linux --release

      - name: Copy FFI Libraries
        working-directory: ${{ env.FLUTTER_DIR }}
        run: |
          mkdir -p build/linux/x64/release/bundle/lib
          cp lib/ffi/linux/*.so build/linux/x64/release/bundle/lib/ || true

      - name: Create Desktop Entry
        run: |
          cat <<EOF > aro-client.desktop
          [Desktop Entry]
          Name=ARO Client
          Exec=/opt/aro-client/aro_client
          Icon=/opt/aro-client/data/flutter_assets/lib/assets/app_icon_1024.png
          Type=Application
          Categories=Utility;
          EOF

      - name: Package DEB
        if: matrix.distro != 'centos:8'
        working-directory: ${{ env.FLUTTER_DIR }}
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | cut -d ' ' -f2 | cut -d '+' -f1)
          fpm -s dir -t deb \
            -n aro-client -v "$VERSION" \
            --description "ARO Client" \
            --depends libgtk-3-0 \
            --depends libwebkit2gtk-4.0-0 \
            build/linux/x64/release/bundle/=/opt/aro-client/ \
            aro-client.desktop=/usr/share/applications/aro-client.desktop

      - name: Package RPM
        if: matrix.distro == 'centos:8'
        working-directory: ${{ env.FLUTTER_DIR }}
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | cut -d ' ' -f2 | cut -d '+' -f1)
          fpm -s dir -t rpm \
            -n aro-client -v "$VERSION" \
            --description "ARO Client" \
            --depends gtk3 \
            --depends webkit2gtk3 \
            build/linux/x64/release/bundle/=/opt/aro-client/ \
            aro-client.desktop=/usr/share/applications/aro-client.desktop

      - name: Upload Packages
        uses: actions/upload-artifact@v4
        with:
          name: linux-packages
          path: |
            ${{ env.FLUTTER_DIR }}/*.deb
            ${{ env.FLUTTER_DIR }}/*.rpm

  build-windows:
    needs: [prepare, build-core-windows]
    if: needs.prepare.outputs.build_core == 'true'
    name: Build Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Visual Studio Build Tools
        uses: ilammy/msvc-dev-cmd@v1

      - name: Download Windows DLL if build_core is true
        if: needs.prepare.outputs.build_core == 'true'
        uses: actions/download-artifact@v4
        with:
          name: libstudy-windows
          path: windows-dll

      - name: Copy DLL to project
        if: needs.prepare.outputs.build_core == 'true'
        run: |
          if (Test-Path "windows-dll/libstudy.dll") {
            New-Item -ItemType Directory -Force -Path "${{ env.FLUTTER_DIR }}/lib/ffi/windows"
            Copy-Item "windows-dll/libstudy.dll" -Destination "${{ env.FLUTTER_DIR }}/lib/ffi/windows/" -Force
          }

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.5"
          cache: true

      - name: Build Flutter Windows app
        working-directory: ${{ env.FLUTTER_DIR }}
        run: |
          flutter config --enable-windows-desktop
          flutter precache --windows
          flutter clean
          flutter pub get
          flutter build windows --release

      - name: Copy DLL next to executable
        if: needs.prepare.outputs.build_core == 'true'
        working-directory: ${{ env.FLUTTER_DIR }}
        run: |
          if (Test-Path "lib/ffi/windows/libstudy.dll") {
            Copy-Item "lib/ffi/windows/libstudy.dll" -Destination "build\windows\x64\runner\Release\" -Force
          }

      - name: Install Inno Setup
        run: |
          choco install innosetup -y
      - name: Create installer script
        working-directory: ${{ env.FLUTTER_DIR }}
        run: |
          $installerScript = @"
          #define MyAppName "ARO Desktop"
          #define MyAppVersion "1.0.0"
          #define MyAppExeName "aro_desktop.exe"
          #define SourcePath ".\build\windows\x64\runner\Release\"

          [Setup]
          AppId={{12345678-1234-1234-1234-123456789012}
          AppName={#MyAppName}
          AppVersion={#MyAppVersion}
          AppVerName={#MyAppName} {#MyAppVersion}
          DefaultDirName={autopf}\{#MyAppName}
          DefaultGroupName={#MyAppName}
          UninstallDisplayIcon={app}\{#MyAppExeName}
          OutputDir=.\
          OutputBaseFilename=AROClient-Setup
          Compression=lzma
          SolidCompression=yes
          PrivilegesRequired=lowest
          ArchitecturesInstallIn64BitMode=x64
          DisableDirPage=no
          AllowUNCPath=no
          AllowNoIcons=yes
          UninstallFilesDir={app}\uninstall
          CreateUninstallRegKey=yes
          Uninstallable=yes

          [Languages]
          Name: "english"; MessagesFile: "compiler:Default.isl"

          [Tasks]
          Name: "desktopicon"; Description: "Create a desktop icon"; GroupDescription: "Additional icons";
          Name: "quicklaunchicon"; Description: "Create a Quick Launch icon"; GroupDescription: "Additional icons"; Flags: unchecked; OnlyBelowVersion: 6.1
          Name: "startmenu"; Description: "Create Start Menu shortcuts"; GroupDescription: "Additional icons";
          Name: "autostart"; Description: "Run at startup"; GroupDescription: "Launch options"; 
          Name: "contextmenu"; Description: "Add context menu shortcuts"; GroupDescription: "Shell integration";



          [Files]
          Source: "{#SourcePath}\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs

          [Icons]
          Name: "{group}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"
          Name: "{autodesktop}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"; Tasks: desktopicon; WorkingDir: "{app}"
          Name: "{userappdata}\Microsoft\Internet Explorer\Quick Launch\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"; Tasks: quicklaunchicon
          Name: "{group}\Uninstall {#MyAppName}"; Filename: "{uninstallexe}"

          [Run]
          Filename: "{app}\{#MyAppExeName}"; Description: "{cm:LaunchProgram,{#StringChange(MyAppName, '&', '&&')}}"; Flags: nowait postinstall skipifsilent

          [Registry]
          Root: "HKCU"; Subkey: "Software\Microsoft\Windows\CurrentVersion\Run"; ValueName: "{#MyAppName}"; ValueType: string; ValueData: "{app}\{#MyAppExeName}"; Flags: uninsdeletevalue; Tasks: autostart
          Root: "HKCU"; Subkey: "Software\Classes\*\shell\Open with {#MyAppName}"; ValueType: string; ValueData: "Open with {#MyAppName}"; Tasks: contextmenu; Flags: uninsdeletekey
          Root: "HKCU"; Subkey: "Software\Classes\*\shell\Open with {#MyAppName}\command"; ValueType: string; ValueData: """{app}\{#MyAppExeName}"" ""%1"""; Tasks: contextmenu

          [UninstallDelete]
          Type: dirifempty; Name: "{app}"
          "@

          Set-Content -Path "aro_installer.iss" -Value $installerScript
      - name: Build installer with Inno Setup
        working-directory: ${{ env.FLUTTER_DIR }}
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\iscc.exe" aro_installer.iss
      - name: Upload Windows Installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: ${{ env.FLUTTER_DIR }}/AROClient-Setup.exe
          if-no-files-found: warn
